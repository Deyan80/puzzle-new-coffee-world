<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Джигсо пъзел - New Coffee WORLD</title>

<meta property="og:title" content="Джигсо пъзел - New Coffee WORLD">
<meta property="og:description" content="Забавлявай се с този джигсо пъзел! Подреди парчетата и открий красивата снимка от New Coffee WORLD. Избери трудност и започни!">
<meta property="og:image" content="new-coffee-world.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="800">
<meta property="og:image:alt" content="Снимка от New Coffee WORLD">
<meta property="og:url" content="https://deyan80.github.io/puzzle-new-coffee-world/">
<meta property="og:type" content="website">

<style>
body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; }
#controls { margin: 20px; }
#board { border: 2px solid #333; background-color: white; display: block; margin: 20px auto; touch-action: none; }
#info { margin: 10px; font-size: 18px; }
button { padding: 10px 15px; margin: 5px; font-size: 16px; }
#source { display: none; }
canvas.dragging { cursor: grabbing; }
</style>
</head>

<body>
<h1>Джигсо пъзел - New Coffee WORLD</h1>

<div id="controls">
<label>Трудност:</label><br>
<button onclick="init(3)">3 x 3 (лесно)</button>
<button onclick="init(4)">4 x 4 (средно)</button>
<button onclick="init(6)">6 x 6 (трудно)</button>
<br><br>
<button onclick="shuffle()">Разбъркай</button>
<button onclick="showSolution()">Покажи</button>
<button id="playPauseBtn" onclick="togglePlay()">Пусни музика</button>
</div>

<canvas id="board" width="600" height="400"></canvas>

<div id="info">
<span>Време: <span id="time">00:00</span></span> |
<span>Ходове: <span id="moves">0</span></span>
</div>

<p>Влачете цветните парчета върху празното място, за да ги преместите.</p>

<img id="source" src="new-coffee-world.jpg" alt="Снимка от New Coffee WORLD">
<audio id="backgroundMusic" src="song.mp3" loop></audio>

<script>
let canvas = document.getElementById('board');
let ctx = canvas.getContext('2d');
let img = document.getElementById('source');
let size = 3;
let tileSize;
let board = [];
let blankPos = {x: 0, y: 0};
let moves = 0;
let timer;
let timeElapsed = 0;
let isSolved = false;
let isLoaded = false;
let draggedTile = null;
let dragOffset = {x:0,y:0};
let lastTouchPos = null;
let audio = document.getElementById('backgroundMusic');
let playPauseBtn = document.getElementById('playPauseBtn');

img.onload = function() {
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    isLoaded = true;
    init(size);
};
img.onerror = function() { alert('Грешка при зареждане на изображението.'); };
if (img.complete) { canvas.width = img.naturalWidth; canvas.height = img.naturalHeight; isLoaded = true; init(size); }

audio.onerror = function() { alert('Грешка при зареждане на музиката.'); }

function togglePlay() {
    if(audio.paused){ audio.play().then(()=>{playPauseBtn.innerText='Спри музика';}).catch(()=>alert('Грешка при пускане на музиката.')) }
    else{ audio.pause(); playPauseBtn.innerText='Пусни музика'; }
}

function init(newSize){
    if(!isLoaded){ alert('Изображението все още не е заредено.'); return; }
    size=newSize;
    tileSize = Math.min(Math.floor(canvas.width/size), Math.floor(canvas.height/size));
    canvas.width = tileSize*size;
    canvas.height = tileSize*size;
    board=Array.from({length:size*size},(_,i)=>i);
    board[size*size-1]=-1;
    blankPos={x:size-1,y:size-1};
    moves=0; timeElapsed=0; isSolved=false;
    document.getElementById('moves').innerText=moves;
    document.getElementById('time').innerText='00:00';
    if(timer) clearInterval(timer);
    timer=setInterval(updateTime,1000);
    draw();
    canvas.removeEventListener('mousedown',startDragging);
    canvas.removeEventListener('mousemove',drag);
    canvas.removeEventListener('mouseup',drop);
    canvas.removeEventListener('mouseleave',cancelDrag);
    canvas.removeEventListener('touchstart',startTouch);
    canvas.removeEventListener('touchmove',touchMove);
    canvas.removeEventListener('touchend',touchEnd);
    canvas.addEventListener('mousedown',startDragging);
    canvas.addEventListener('mousemove',drag);
    canvas.addEventListener('mouseup',drop);
    canvas.addEventListener('mouseleave',cancelDrag);
    canvas.addEventListener('touchstart',startTouch,{passive:false});
    canvas.addEventListener('touchmove',touchMove,{passive:false});
    canvas.addEventListener('touchend',touchEnd,{passive:false});
}

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='#ccc';
    for(let i=0;i<=size;i++){
        ctx.beginPath(); ctx.moveTo(i*tileSize,0); ctx.lineTo(i*tileSize,canvas.height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,i*tileSize); ctx.lineTo(canvas.width,i*tileSize); ctx.stroke();
    }
    for(let i=0;i<board.length;i++){
        let row=Math.floor(i/size), col=i%size, x=col*tileSize, y=row*tileSize;
        let tileNum=board[i];
        if(tileNum!==-1 && i!==draggedTile){
            let srcRow=Math.floor(tileNum/size), srcCol=tileNum%size;
            ctx.drawImage(img, srcCol*tileSize, srcRow*tileSize, tileSize, tileSize, x, y, tileSize, tileSize);
        } else if(tileNum===-1){ ctx.fillStyle='white'; ctx.fillRect(x,y,tileSize,tileSize); ctx.strokeStyle='#333'; ctx.strokeRect(x,y,tileSize,tileSize);}
    }
}

function getTileAt(x,y){let col=Math.floor(x/tileSize); let row=Math.floor(y/tileSize); return (col>=0&&col<size&&row>=0&&row<size)? row*size+col:-1; }
function startDragging(e){ if(isSolved) return; let r=canvas.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top; let i=getTileAt(x,y); if(i>=0 && board[i]!==-1) draggedTile=i; }
function drag(e){ if(draggedTile===null)return; }
function drop(e){ if(draggedTile===null) return; let r=canvas.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top; let target=getTileAt(x,y), blankIndex=blankPos.y*size+blankPos.x; if(target===blankIndex){ [board[draggedTile],board[blankIndex]]=[board[blankIndex],board[draggedTile]]; blankPos={x:draggedTile%size,y:Math.floor(draggedTile/size)}; moves++; document.getElementById('moves').innerText=moves; draw(); checkSolved(); } draggedTile=null;}
function cancelDrag(){ draggedTile=null; }

function startTouch(e){ startDragging(e.touches[0]); }
function touchMove(e){ e.preventDefault(); }
function touchEnd(e){ drop(e.changedTouches[0]); }

function shuffle(){ if(isSolved) return; for(let i=0;i<1000;i++){ let dirs=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}]; let d=dirs[Math.floor(Math.random()*4)]; let nx=blankPos.x+d.dx, ny=blankPos.y+d.dy; if(nx>=0&&nx<size&&ny>=0&&ny<size){ let ni=ny*size+nx,bi=blankPos.y*size+blankPos.x; [board[ni],board[bi]]=[board[bi],board[ni]]; blankPos={x:nx,y:ny}; } } moves=0; timeElapsed=0; document.getElementById('moves').innerText=moves; document.getElementById('time').innerText='00:00'; draw(); }

function showSolution(){ board=Array.from({length:size*size},(_,i)=>i); board[size*size-1]=-1; blankPos={x:size-1,y:size-1}; isSolved=true; moves=0; document.getElementById('moves').innerText=moves; clearInterval(timer); draw(); }

function updateTime(){ timeElapsed++; let m=String(Math.floor(timeElapsed/60)).padStart(2,'0'), s=String(timeElapsed%60).padStart(2,'0'); document.getElementById('time').innerText=`${m}:${s}`; }

function checkSolved(){ let solved=board.every((v,i)=>v===i || (i===board.length-1 && v===-1)); if(solved){ isSolved=true; clearInterval(timer); draw(); alert('Поздравления! Решихте пъзела!'); } }
</script>

</body>
</html>
